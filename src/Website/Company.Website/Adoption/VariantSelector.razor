@inject AdoptionService AdoptionService

@foreach (var availableVariantType in _availableVariantTypes)
{
    <h5 class="attribute-heading">@availableVariantType.Key:</h5>
    <select class="form-control" @onchange="e => OnNewValueSelected(availableVariantType.Key, e)">
        <option value=""></option>
        @foreach (var availableVariableValue in availableVariantType.Value)
        {
            <option value="@availableVariableValue" selected="@(SelectedVariant?.VariantTypeValues[availableVariantType.Key] == availableVariableValue)">@availableVariableValue</option>
        }
    </select>
}

@code {
    [Parameter] public AdoptableRock AdoptableRock { get; set; }
    [Parameter] public List<AdoptableRockVariant> Variants { get; set; }
    [Parameter] public AdoptableRockVariant SelectedVariant { get; set; }
    [Parameter] public Action<AdoptableRockVariant> NewVariantSelected { get; set; }

    private Dictionary<string, List<string>> _availableVariantTypes;
    private Dictionary<string, string> _selectedVariantTypes;

    protected override void OnParametersSet()
    {
        var availableVariants = new Dictionary<string, List<string>>();

        foreach (var variantType in AdoptableRock.VariantTypes)
        {
            availableVariants.Add(variantType, []);
        }

        foreach (var variant in Variants)
        {
            foreach (var variantTypeValue in variant.VariantTypeValues)
            {
                availableVariants[variantTypeValue.Key].Add(variantTypeValue.Value);
            }
        }

        _availableVariantTypes = availableVariants.ToDictionary(x => x.Key, x => x.Value.Distinct().ToList());

        _selectedVariantTypes = SelectedVariant != null ? SelectedVariant.VariantTypeValues : availableVariants.ToDictionary(x => x.Key, _ => string.Empty);
    }

    private void OnNewValueSelected(string changedVariantType, Microsoft.AspNetCore.Components.ChangeEventArgs e)
    {
        _selectedVariantTypes[changedVariantType] = (string)e.Value;
        var selectedVariantReduceList = Variants;
        foreach (var variantType in _availableVariantTypes)
        {
            var selectedVariantType = variantType.Key == changedVariantType
                ? (string)e.Value
                : _selectedVariantTypes[variantType.Key];
            selectedVariantReduceList = selectedVariantReduceList.Where(v => v.VariantTypeValues[variantType.Key] == selectedVariantType).ToList();
        }

        if (selectedVariantReduceList.Any())
        {
            NewVariantSelected(selectedVariantReduceList.Single());
        }
    }

}
